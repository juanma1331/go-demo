package layouts

import (
	"github.com/juanma1331/go-demo/views/components/icons"
	"fmt"
	"github.com/juanma1331/go-demo/internal/shared"
	"github.com/juanma1331/go-demo/views"
)

type CartProductViewModel struct {
	DetailID           string
	ProductID          string
	ProductName        string
	ProductDescription string
	ProductPrice       int64
	Quantity           int
}

templ cartToggler() {
	<button
		id="cart-toggler"
		aria-controls="cart"
		aria-expanded="false"
		class="bg-slate-800 transition-transform py-1 px-2 rounded-md shadow-md shadow-slate-800"
		_="on click
			if #cart's @data-state == 'closed' 
				remove .shadow-md from me
				set my *transform to 'scale(0.95)'
				set @aria-expanded to true

			else 
				add .shadow-md to me
				set my *transform to 'scale(1)'
				set @aria-expanded to false
			end 
			send cart_toggle to #cart"
	>
		@cartCounter()
	</button>
}

templ cartCounter() {
	<div class="relative h-8 w-8 flex items-center">
		<span
			id="cart-counter"
			class="absolute top-0 right-0 justify-center rounded-full text-xs font-light text-green-50 "
			_="on cart_updated(value) from body set result to value as an Object 
					then put result.quantity into me"
		>
			0
		</span>
		@icons.Cart()
	</div>
}

templ cart() {
	<div
		id="cart"
		class="absolute top-14 right-[-32rem] w-[32rem] min-h-screen transition-all ease-in-out z-10 p-4 border border-1 border-slate-200 bg-white"
		data-state="closed"
		_="on every cart_toggle
			if @data-state == 'closed' 
				set @data-state to 'open'
				transition my *right to 0rem over 0.2 seconds
			else 
				set @data-state to 'closed'
				transition my *right to initial over 0.2 seconds
			end"
	>
		<h2 class="text-md font-semibold mb-2 text-slate-700">Your products</h2>
		<ul
			id="cart-placeholder"
			hx-get="/cart"
			hx-trigger="load"
			hx-target="this"
			hx-indicator="#indicator"
			class="space-y-2"
		>
			<div id="indicator">
				Loading cart...
			</div>
		</ul>
		<div
			class="flex justify-center items-center h-32 w-full border border-slate-300 rounded-md p-4"
			_="on cart_updated(value) from body 
				set result to value as an Object
				set total to result.total as Int
				if total == 0
					show me
					hide #cart-total
				else
					hide me
					show #cart-total
				end"
		>
			<p class="text-slate-700">The cart is empty</p>
		</div>
		<div
			id="cart-total"
			class="flex justify-between items-center gap-2 mt-4"
			_="on cart_updated(value) from body 
					set result to value as an Object
					then put '$' + result.total into #total-price"
		>
			Total:  <span id="total-price" class="text-slate-900">0</span>
		</div>
	</div>
}

templ Cart(models []CartProductViewModel, token string) {
	for _, m := range models {
		@CartProduct(m, token)
	}
}

templ CartProduct(m CartProductViewModel, token string) {
	<li
		id={ fmt.Sprintf("cart-item-%s", m.DetailID) }
		class="flex items-center gap-2 border border-slate-300 rounded-md p-1"
	>
		<img
			src={ fmt.Sprintf("/products/%s/image/small", m.ProductID) }
			alt={ fmt.Sprintf("a small image of %s", m.ProductName) }
			class="aspect-square h-16 rounded-md"
		/>
		<div class="w-full h-16 flex items-center justify-between gap-2">
			<div class="flex flex-col justify-between h-full">
				<h2 class="text-sm font-semibold text-slate-900">{ m.ProductName }</h2>
				<p
					data-cart-item-price={ views.FormatPrice(m.ProductPrice) }
					class="text-xs text-slate-700"
				>
					${ views.FormatPrice(m.ProductPrice) }
				</p>
				<p class="text-xs text-slate-700">{ "Qty:  " }{ fmt.Sprintf("%d", m.Quantity) }</p>
			</div>
			if m.Quantity > 1 {
				@decreateQuantityForm(m.DetailID, token)
			} else {
				@removeFromCartForm(m.DetailID, token)
			}
		</div>
	</li>
}

templ removeFromCartForm(detailID string, token string) {
	<form hx-post="/cart/delete" hx-target={ fmt.Sprintf("#cart-item-%s", detailID) } hx-swap="outerHTML">
		<input type="hidden" name="cart_detail_id" value={ detailID }/>
		<input type="hidden" name={ shared.CSRFTokenKey } value={ token }/>
		<button type="submit" class="py-1 px-2 text-slate-50 text-sm bg-slate-500 rounded-md shadow-md">
			X
		</button>
	</form>
}

templ decreateQuantityForm(detailID string, token string) {
	<form hx-patch="/cart" hx-target={ fmt.Sprintf("#cart-item-%s", detailID) } hx-swap="outerHTML">
		<input type="hidden" name="cart_detail_id" value={ detailID }/>
		<input type="hidden" name={ shared.CSRFTokenKey } value={ token }/>
		<button type="submit" class="py-1 px-2 text-slate-50 text-sm bg-slate-500 rounded-md shadow-md">
			-
		</button>
	</form>
}
